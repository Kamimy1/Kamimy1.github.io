<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Circulos con mensajes</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="flip-landscape">
        <i class="fa-solid fa-rotate"></i>
    </div>
    <div class="container" oncontextmenu="togglePointsCreation(event)">
        <img src="https://www.osuna.es/export/sites/osuna/.galleries/Mutimedia/Calles/MIRADOR-DE-LA-COLEGIATA.jpg_538135410.jpg"
            alt="Imagen" id="imagen">
    </div>
    <script>
        var messages = {};
        var circlesData = [
            {
                "x": 456,
                "y": 786,
                "message": "Hola, esta semana es una fiesta fun fun fun en navidad lo que queremos es telefonica, el mejor duo por solo 29.80 al mes, estas denominado Si quieres gratis iva, ahora gratis es ohyeah"
            },
            {
                "x": 1513,
                "y": 562,
                "message": "2"
            },
            {
                "x": 168,
                "y": 896,
                "message": "3"
            },
            {
                "x": 604,
                "y": 218,
                "message": "44"
            }
        ];
        var pointsCreationEnabled = false;
        var ventanaAncho = Math.max(screen.width, screen.height);
        var ventanaAlto = window.innerHeight;
        var imagen = document.getElementById('imagen');

        window.onload = function () {
            buildApp();
        }

        function buildApp() {
            for (var i = 0; i < circlesData.length; i++) {
                var circleData = circlesData[i];
                circleData.x = (ventanaAncho / (imagen.naturalWidth / circleData.x));
                circleData.y = ((ventanaAncho / (imagen.naturalWidth / imagen.naturalHeight)) / (imagen.naturalHeight / circleData.y));
                console.log(circleData.x + "\n" + circleData.y);
            }
            imagen.style.width = Math.max(screen.width, screen.height) + 'px';
            circlesData.forEach(function (data, index) {
                renderCircle(data);
            });
        }

        /**function togglePointsCreation(event) {
            event.preventDefault(); // Evita que aparezca el menu contextual del navegador al hacer clic derecho
            pointsCreationEnabled = !pointsCreationEnabled;
            if (pointsCreationEnabled) {
                document.body.style.cursor = 'crosshair'; // Cambia el cursor para indicar que la creacion de puntos esta habilitada
            } else {
                document.body.style.cursor = 'auto'; // Restaura el cursor predeterminado
            }
        }**/

        function addCircle(event) {
            if (!pointsCreationEnabled) return;
            const rect = imagen.getBoundingClientRect();
            var x = (event.clientX - Math.trunc(rect.left));
            var y = (event.clientY - Math.trunc(rect.top));

            console.log(
                'Event Click X: ' + event.clientX + '\n' + 'Event Click Y: ' + event.clientY
            );
            console.log(
                'Imagen X: ' + event.clientX + '-' + '(' + Math.trunc(rect.left) + ')' + ': ' + x + '\n' + 'Imagen Y: ' + event.clientY + '-' + '(' + Math.trunc(rect.top) + ')' + ': ' + y
            );
            console.log(
                'Offset X: ' + imagen.offsetWidth + '\n' + 'Offset Y: ' + imagen.offsetHeight
            );

            var message = prompt("Introduce el mensaje para este circulo:");
            if (message) {
                circlesData.push({ x: x, y: y, message: message });
                renderCircle({ x: x, y: y, message: message });
            }
        }

        function showMessage(circle, message) {
            var messageId = circle.dataset.messageId;

            if (!messageId) {
                // Si no hay un mensaje asociado con este circulo, crear uno nuevo
                var messageBox = document.createElement('div');
                messageBox.className = 'message-box';

                var circleRadius = circle.offsetWidth * 0.5;
                var messageText = document.createTextNode(message);
                messageBox.style.left = (circle.offsetLeft + circleRadius) + 'px';
                messageBox.style.top = (circle.offsetTop - circleRadius) + 'px';

                var closeBtn = document.createElement('span');
                closeBtn.className = 'close-btn';
                closeBtn.innerHTML = '&nbsp;&nbsp;<sup style>X</sup>';

                closeBtn.onclick = function () {
                    messageBox.parentNode.removeChild(messageBox);
                    delete messages[messageId];
                    delete circle.dataset.messageId;
                };

                var infoLink = document.createElement('a');
                if (message === "Hola, esta semana es una fiesta fun fun fun en navidad lo que queremos es telefonica, el mejor duo por solo 29.80 al mes, estas denominado Si quieres gratis iva, ahora gratis es ohyeah") {
                    infoLink.href = "prueba.html";
                } else if (message === "3") {
                    infoLink.href = "prueba2.html";
                } else {
                    infoLink.href = "#"; // Default link or no link
                }
                infoLink.innerHTML = " más información aquí";
                infoLink.style.textDecoration = "underline";
                infoLink.style.color = "blue";
                infoLink.style.cursor = "pointer";

                messageBox.appendChild(closeBtn);
                messageBox.appendChild(messageText);
                messageBox.appendChild(infoLink);

                document.body.appendChild(messageBox);

                // Almacenar el mensaje asociado a este circulo
                messageId = Date.now();
                circle.dataset.messageId = messageId;
                messages[messageId] = messageBox;
            }

            requestAnimationFrame(function () {
                var messageElement = messages[messageId];
                var numCaracteres = messageElement.innerText.length;
                var ventanaAncho = Math.max(screen.width, screen.height);
                var imagenAncho = imagen.naturalWidth;
                var anchoDeseado = (ventanaAncho / imagenAncho) * numCaracteres * 5;
                messageElement.style.width = anchoDeseado + 'px';
                var fontSize = (ventanaAncho / imagenAncho) * 16;
                messageElement.style.fontSize = fontSize + 'px';
                var padding = (ventanaAncho / 100) + 'px';
                var border = (ventanaAncho / imagenAncho) + 'px';
                messageElement.style.padding = padding;
                messageElement.style.borderWidth = border;
            });

            messages[messageId].style.display = 'block';
        }

        // Función para renderizar un círculo
        function renderCircle(data) {
            var relacionCirculo = (Math.max(screen.width, screen.height) * 10) / imagen.naturalWidth;
            var container = document.querySelector('.container');
            var circle = document.createElement('div');
            circle.className = 'circle';

            circle.onclick = function () {
                showMessage(circle, data.message);
            };
            circle.style.left = ((data.x - (relacionCirculo / 2)) + 'px');
            circle.style.top = ((data.y - (relacionCirculo / 2)) + 'px');
            circle.style.width = relacionCirculo + "px";
            circle.style.height = relacionCirculo + "px";
            container.appendChild(circle);
        }

        function extraerInformacion(event) {
            if (event.keyCode === 86) {
                console.log("Messages:", JSON.stringify(messages));
                console.log("CirclesData:", JSON.stringify(circlesData));
            }
        }

         // Escuchar los clics en la pagina para agregar circulos si la creacion de puntos esta habilitada
        document.addEventListener('click', addCircle);
        document.addEventListener("keypress", extraerInformacion);

        let wasPortrait = screen.orientation.type.startsWith('portrait');

        screen.orientation.addEventListener("change", (event) => {
            let isPortrait = screen.orientation.type.startsWith('portrait');

            if (wasPortrait && !isPortrait) {
                imagen.style.width = Math.max(screen.width, screen.height) + 'px';
                document.querySelectorAll('.circle').forEach(circle => circle.remove());
                circlesData.forEach(function (data, index) {
                    renderCircle(data);
                });

                console.log("1Ancho:" + screen.width + "\n" + "Alto:" + screen.height);
            }
            wasPortrait = isPortrait;
        });
    </script>
</body>

</html>
